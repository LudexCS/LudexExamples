// This automation is generated by ChatGPT 4o
// scripts/init-scenario.js
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const scenarioName = process.argv[2];
if (!scenarioName) {
  console.error('❌ 시나리오 이름을 입력하세요.');
  console.log('Usage: node scripts/init-scenario.js <scenario-name>');
  process.exit(1);
}

const baseDir = path.resolve(__dirname, '..', 'scenarios', scenarioName);
const srcDir = path.join(baseDir, 'src');
const frontendDir = path.join(srcDir, 'frontend');
const publicDir = path.join(baseDir, 'dist/public/js');

console.log(`📦 Creating scenario: ${scenarioName}`);
fs.mkdirSync(frontendDir, { recursive: true });
fs.mkdirSync(publicDir, { recursive: true });
process.chdir(baseDir);

// npm 프로젝트 및 ts 초기화
execSync('npm init -y', { stdio: 'ignore' });
execSync('npx tsc --init', { stdio: 'ignore' });

// tsconfig 강제 덮어쓰기
const tsconfigFull = {
  compilerOptions: {
    target: "ES2020",
    module: "CommonJS",
    rootDir: "./src",
    outDir: "./dist",
    esModuleInterop: true,
    strict: true,
    skipLibCheck: true,
    typeRoots: ["./node_modules/@types"]
  }
};
fs.writeFileSync(path.join(baseDir, 'tsconfig.json'), JSON.stringify(tsconfigFull, null, 2));

// index.ts 생성
fs.writeFileSync(path.join(srcDir, 'index.ts'), [
  'import express, { Request, Response } from "express";',
  'import path from "path";',
  '',
  'const app = express();',
  'const port = 4000;',
  '',
  'app.use(express.static(path.join(__dirname, "public")));',
  '',
  'app.get("/api/trigger", (_req: Request, res: Response) => {',
  '  res.json({ message: "Triggered from backend!" });',
  '});',
  '',
  'app.listen(port, () => {',
  '  console.log(`Server running at http://localhost:${port}`);',
  '});'
].join('\n'));

// frontend.ts 생성
fs.writeFileSync(path.join(frontendDir, 'frontend.ts'), [
  'document.getElementById("trigger")?.addEventListener("click", async () => {',
  '  try {',
  '    const res = await fetch("/api/trigger");',
  '    const data = await res.json();',
  '    document.getElementById("result")!.textContent = JSON.stringify(data, null, 2);',
  '  } catch (err) {',
  '    document.getElementById("result")!.textContent = "⚠️ Error: " + err;',
  '  }',
  '});'
].join('\n'));

// index.html 생성
fs.writeFileSync(path.join(frontendDir, 'index.html'), [
  '<!DOCTYPE html>',
  '<html lang="en">',
  '<head>',
  '  <meta charset="UTF-8" />',
  `  <title>Scenario: ${scenarioName}</title>`,
  '</head>',
  '<body>',
  `  <h1>Scenario: ${scenarioName}</h1>`,
  '  <button id="trigger">Run Scenario</button>',
  '  <pre id="result"></pre>',
  '',
  '  <script src="js/frontend.js"></script>',
  '</body>',
  '</html>'
].join('\n'));

// HTML 복사
fs.copyFileSync(
  path.join(frontendDir, 'index.html'),
  path.join(baseDir, 'dist/public/index.html')
);

// start & build 스크립트 등록
execSync(`npx npm pkg set scripts.build="tsc && npm run build-frontend"`, { stdio: 'ignore' });
execSync(`npx npm pkg set scripts.build-frontend="esbuild src/frontend/frontend.ts --bundle --outfile=dist/public/js/frontend.js --format=iife"`, { stdio: 'ignore' });
execSync(`npx npm pkg set scripts.start="node dist/index.js"`, { stdio: 'ignore' });
execSync(`npx npm pkg set dependencies.ludex="file:../../packages/LudexWeb3Integration"`, { stdio: 'ignore' });
execSync('npm install -D @types/node undici-types esbuild', { stdio: 'inherit' });

// 루트 package.json 업데이트
const rootPkgPath = path.resolve(__dirname, '..', 'package.json');
const rootPkg = JSON.parse(fs.readFileSync(rootPkgPath, 'utf8'));
rootPkg.scripts = rootPkg.scripts || {};
rootPkg.scripts[`start:${scenarioName}`] = `npm start --workspace=scenarios/${scenarioName}`;
rootPkg.scripts[`build:${scenarioName}`] = `npm run build --workspace=scenarios/${scenarioName}`;
fs.writeFileSync(rootPkgPath, JSON.stringify(rootPkg, null, 2));

// 완료 메시지
console.log(`✅ ${scenarioName} 시나리오 생성 완료!`);
console.log(`📦 esbuild 설치 필요 시: npm install -D esbuild`);
console.log(`💡 Build: npm run build:${scenarioName}`);
console.log(`🚀 Run  : npm run start:${scenarioName}`);
